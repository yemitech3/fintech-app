permissions:
  id-token: write
  contents: read

name: CI-CD Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'prod'
        type: choice
        options: [dev, qa, uat, prod]
      image_tag:
        description: 'Docker Image Tag (e.g., 1.0.0)'
        required: false

env:
  AWS_REGION: us-east-2
  AWS_ACCOUNT_ID: "043310666010"
  ECR_REPO: fintech-app

jobs:
  debug-aws-setup:
    name: Debug AWS Setup
    runs-on: self-hosted
    steps:
      - name: Check AWS CLI version
        run: |
          echo "AWS CLI Version:"
          aws --version
          
      - name: Check AWS credentials
        run: |
          echo "Testing AWS credentials..."
          aws sts get-caller-identity || echo "AWS credentials are not configured or invalid"
          
      - name: Check Docker setup
        run: |
          echo "Docker Version:"
          docker --version
          echo ""
          echo "Current user: $(whoami)"
          echo "User groups: $(groups)"
          
      - name: Try ECR login manually
        run: |
          echo "Testing ECR login..."
          echo "AWS Account ID: ${{ env.AWS_ACCOUNT_ID }}"
          echo "AWS Region: ${{ env.AWS_REGION }}"
          echo "ECR Repo: ${{ env.ECR_REPO }}"
          
          # Test AWS ECR get-login-password
          echo "1. Testing aws ecr get-login-password..."
          aws ecr get-login-password --region ${{ env.AWS_REGION }} && echo "‚úÖ Success" || echo "‚ùå Failed"
          
          # Test full ECR URL
          echo "2. Testing ECR registry URL..."
          ECR_URL="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          echo "ECR URL: $ECR_URL"
          
          # Test if ECR repository exists
          echo "3. Checking if ECR repository exists..."
          aws ecr describe-repositories --repository-names ${{ env.ECR_REPO }} --region ${{ env.AWS_REGION }} && echo "‚úÖ Repository exists" || echo "‚ùå Repository does not exist"
          
      - name: Create test script
        run: |
          cat > test-ecr-login.sh << 'EOF'
          #!/bin/bash
          set -e
          
          AWS_REGION="${{ env.AWS_REGION }}"
          AWS_ACCOUNT_ID="${{ env.AWS_ACCOUNT_ID }}"
          ECR_REPO="${{ env.ECR_REPO }}"
          
          echo "=== Testing ECR Login ==="
          echo "AWS Account: $AWS_ACCOUNT_ID"
          echo "AWS Region: $AWS_REGION"
          echo "ECR Repo: $ECR_REPO"
          
          # Get ECR password
          echo "Getting ECR login password..."
          PASSWORD=$(aws ecr get-login-password --region $AWS_REGION)
          if [ $? -eq 0 ]; then
            echo "‚úÖ Got ECR password"
          else
            echo "‚ùå Failed to get ECR password"
            exit 1
          fi
          
          # Try docker login
          echo "Attempting Docker login..."
          ECR_REGISTRY="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"
          echo $PASSWORD | docker login --username AWS --password-stdin $ECR_REGISTRY
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Successfully logged into ECR"
          else
            echo "‚ùå Failed to login to ECR"
            exit 1
          fi
          EOF
          
          chmod +x test-ecr-login.sh
          
      - name: Run test script
        run: |
          ./test-ecr-login.sh

  build-and-push:
    name: Build and Push Docker Image
    runs-on: self-hosted
    timeout-minutes: 60
    needs: debug-aws-setup
    outputs:
      image-tag: ${{ steps.set-tag.outputs.image-tag }}

    steps:
      - name: Checkout Source
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: |
          source /etc/profile.d/maven.sh || true
          mvn clean package -DskipTests

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=fintech-app
            -Dsonar.projectName='fintech-app'
            -Dsonar.sources=.
            -Dsonar.java.binaries=target/classes

      - name: Set Image Tag
        id: set-tag
        run: |
          TAG="${{ github.event.inputs.image_tag }}"
          if [ -z "$TAG" ]; then
            TAG=$(date +%Y%m%d%H%M%S)
            echo "Generated unique image tag: $TAG"
          else
            echo "Using provided image tag: $TAG"
          fi
          echo "image-tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
        id: aws-creds

      - name: Debug AWS Credentials
        run: |
          echo "AWS credentials configured"
          echo "AWS Region: ${{ env.AWS_REGION }}"
          echo "AWS Account ID: ${{ env.AWS_ACCOUNT_ID }}"
          echo "Testing AWS identity..."
          aws sts get-caller-identity

      - name: Ensure ECR Repository Exists
        run: |
          echo "Checking ECR repository: ${{ env.ECR_REPO }}"
          if aws ecr describe-repositories --repository-names "${{ env.ECR_REPO }}" --region "${{ env.AWS_REGION }}" > /dev/null 2>&1; then
            echo "‚úÖ ECR repository '${{ env.ECR_REPO }}' exists."
          else
            echo "üîÑ Creating ECR repository '${{ env.ECR_REPO }}'..."
            aws ecr create-repository \
              --repository-name "${{ env.ECR_REPO }}" \
              --region "${{ env.AWS_REGION }}"
            echo "‚úÖ ECR repository created."
          fi

      - name: Login to AWS ECR
        run: |
          echo "üîê Logging into AWS ECR..."
          ECR_REGISTRY="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          echo "ECR Registry: $ECR_REGISTRY"
          
          # Get authorization token
          echo "Getting ECR authorization token..."
          aws ecr get-authorization-token --region "${{ env.AWS_REGION }}" --output text
          
          # Login to ECR
          echo "Logging into Docker..."
          aws ecr get-login-password --region "${{ env.AWS_REGION }}" | \
            docker login --username AWS --password-stdin "$ECR_REGISTRY"
          
          echo "‚úÖ Successfully logged into ECR"

      - name: Build Docker Image
        run: |
          IMAGE_TAG="${{ steps.set-tag.outputs.image-tag }}"
          ECR_REGISTRY="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          IMAGE_URI="$ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG"
          
          echo "üî® Building Docker image..."
          echo "Image URI: $IMAGE_URI"
          
          # Check if Dockerfile exists
          if [ ! -f "Dockerfile" ]; then
            echo "‚ùå Dockerfile not found!"
            ls -la
            exit 1
          fi
          
          # Build the image
          docker build -t "$IMAGE_URI" .
          echo "‚úÖ Docker image built successfully"

      - name: Push Docker Image to ECR
        run: |
          IMAGE_TAG="${{ steps.set-tag.outputs.image-tag }}"
          ECR_REGISTRY="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          IMAGE_URI="$ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG"
          
          echo "üì§ Pushing Docker image to ECR..."
          echo "Pushing: $IMAGE_URI"
          
          # Push the image
          docker push "$IMAGE_URI"
          
          echo "‚úÖ Docker image pushed successfully"

  deploy:
    name: Deploy to EKS
    runs-on: self-hosted
    needs: build-and-push
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Application
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
          ECR_REGISTRY="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          IMAGE_URI="$ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG"
          
          echo "Deploying to environment: $ENV"
          echo "Using image: $IMAGE_URI"
          
          # Your deployment logic here
          echo "‚úÖ Deployment would happen here"
